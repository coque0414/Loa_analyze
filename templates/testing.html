{% extends "base.html" %}
{% block title %}ë¡œì•„ ë„ìš°ë¯¸ â€“ RAG ì±—ë´‡{% endblock %}

{% block content %}
<style>
  /* ë ˆì´ì•„ì›ƒ */
  .chat-card{
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 18px;
    box-shadow: var(--shadow);
  }
  #chatWindow{
    height: min(68vh, 780px); /* ë²„íŠ¼ ì˜ì—­ ì¶”ê°€ë¡œ ì•½ê°„ ì¤„ì„ */
    overflow-y: auto;
    padding: 20px;
    background: linear-gradient(180deg, #ffffff 0%, #fbfdfc 100%);
    border-radius: 14px;
  }

  /* ë§í’ì„  ê³µí†µ */
  .bubble{
    display:inline-block;
    max-width: 88%;
    padding: 12px 14px;
    border-radius: 14px;
    line-height: 1.6;
    font-size: 16.5px;
    word-break: break-word;
    white-space: pre-wrap;
    box-shadow: 0 2px 10px rgba(0,0,0,.04);
  }
  /* ë´‡(ì™¼ìª½ ì •ë ¬) */
  .row-bot{ text-align:left; margin: 8px 0 }
  .bubble-bot{
    background: var(--bot);
    color: var(--text);
    border: 1px solid var(--border);
  }
  /* ìœ ì €(ì˜¤ë¥¸ìª½ ì •ë ¬) */
  .row-user{ text-align:right; margin: 8px 0 }
  .bubble-user{
    background: linear-gradient(135deg, var(--user-grad-a), var(--user-grad-b));
    color: #0b2530;
    border: none;
    animation: popIn .18s ease-out;
  }
  @keyframes popIn{
    from{ transform: scale(.9); opacity: .0 }
    to  { transform: scale(1);  opacity: 1 }
  }

  /* ì¹´ë“œ/ì´ë¯¸ì§€ ì˜ì—­ */
  .answer-block{
    text-align:left; margin: 10px 0;
  }
  .answer-card{
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px;
    box-shadow: var(--shadow);
  }

  /* ë¡œë”©: íšŒì „ ì›í˜• ìŠ¤í”¼ë„ˆ */
  .spinner {
    width: 22px; height: 22px;
    border: 3px solid #d1e8e4;
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    display:inline-block; vertical-align:middle; margin-left:6px;
  }
  @keyframes spin { to { transform: rotate(360deg) } }

  /* ì†ŒìŠ¤ ì¹´ë“œ (ì˜µì…˜) */
  .source-card {
    background-color: #f4faf8;
    border-left: 4px solid var(--accent);
    padding: .5rem .75rem;
    margin-top: .5rem;
    border-radius: .5rem;
    font-size: 14px;
  }
  .source-card a{ text-decoration:none; color:#0b7266; font-weight:600 }
  .source-card small{ color: var(--muted) }

  @media (max-width: 576px){
    .bubble{ max-width:100%; font-size: 16px }
  }

  /* ì¹´ë“œ/ì´ë¯¸ì§€ íŒ ì• ë‹ˆë©”ì´ì…˜ */
  .animate-pop{ 
    animation: popCard .24s cubic-bezier(.2,.8,.2,1);
    transform-origin: 50% 55%;
  }
  @keyframes popCard{
    0%   { transform: scale(.92); opacity: 0 }
    60%  { transform: scale(1.03); opacity: 1 }
    100% { transform: scale(1) }
  }

  /* ì´ë¯¸ì§€ê°€ ëŠ¦ê²Œ ë¡œë“œë  ë•Œ ë¶€ë“œëŸ½ê²Œ ë‚˜íƒ€ë‚˜ê¸° */
  .answer-card img{ opacity: 0; transition: opacity .2s ease }
  .answer-card img.loaded{ opacity: 1 }

  /* ============================================
     âœ… ë¹ ë¥¸ ì§ˆë¬¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼
     ============================================ */
  .quick-questions-wrapper {
    position: relative;
    margin-bottom: 12px;
  }
  
  .quick-questions {
    display: flex;
    gap: 10px;
    overflow-x: auto;
    padding: 8px 4px;
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE/Edge */
    scroll-behavior: smooth;
  }
  .quick-questions::-webkit-scrollbar {
    display: none; /* Chrome, Safari */
  }
  
  .quick-btn {
    flex-shrink: 0;
    padding: 10px 16px;
    border: 1.5px solid #d1e8e4;
    border-radius: 20px;
    background: #fff;
    color: #0b7266;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
  }
  .quick-btn:hover {
    background: #e8f7f3;
    border-color: var(--accent);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(11, 114, 102, 0.15);
  }
  .quick-btn:active {
    transform: translateY(0);
  }
  
  /* ìŠ¤í¬ë¡¤ í™”ì‚´í‘œ ë²„íŠ¼ */
  .scroll-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: white;
    border: 1px solid #d1e8e4;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    transition: all 0.2s ease;
  }
  .scroll-arrow:hover {
    background: #e8f7f3;
    border-color: var(--accent);
  }
  .scroll-arrow.left { left: -8px; }
  .scroll-arrow.right { right: -8px; }
  .scroll-arrow svg {
    width: 16px;
    height: 16px;
    fill: #0b7266;
  }
  
  /* í™”ì‚´í‘œ ìˆ¨ê¸°ê¸° (ìŠ¤í¬ë¡¤ ë¶ˆí•„ìš” ì‹œ) */
  .scroll-arrow.hidden {
    opacity: 0;
    pointer-events: none;
  }

</style>

<div class="container py-4">
  <div class="d-flex align-items-center mb-3" style="gap:10px">
    <img src="https://static.thenounproject.com/png/1245340-200.png" alt="mokoko"
         width="28" height="28" style="opacity:.8"/>
    <h2 class="m-0" style="font-weight:800; letter-spacing:-.3px">ë¡œì•„ ë„ìš°ë¯¸</h2>
    <span class="ms-2 badge rounded-pill" style="background:#e8f7f3; color:#0b7266">ChatBot</span>
  </div>

  <div class="chat-card p-3">
    <div id="chatWindow"></div>

    <!-- âœ… ë¹ ë¥¸ ì§ˆë¬¸ ë²„íŠ¼ ì˜ì—­ -->
    <div class="quick-questions-wrapper">
      <button class="scroll-arrow left hidden" id="scrollLeft">
        <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
      </button>
      <div class="quick-questions" id="quickQuestions">
        <button class="quick-btn" data-question="ë¡œìŠ¤íŠ¸ì•„í¬ëŠ” ë¬´ìŠ¨ ê²Œì„ì´ì—ìš”?">ë¡œìŠ¤íŠ¸ì•„í¬ëŠ” ë¬´ìŠ¨ ê²Œì„ì´ì—ìš”?</button>
        <button class="quick-btn" data-question="ì˜¤ëŠ˜ ëª¨í—˜ì„¬ ì¼ì • ì•Œë ¤ì£¼ì„¸ìš”">ì˜¤ëŠ˜ ëª¨í—˜ì„¬ ì¼ì • ì•Œë ¤ì£¼ì„¸ìš”</button>
        <button class="quick-btn" data-question="ì›í•œ ê°ì¸ì„œ ê°€ê²© ì•Œë ¤ì¤˜">ì›í•œ ê°ì¸ì„œ ê°€ê²© ì•Œë ¤ì¤˜</button>
        <button class="quick-btn" data-question="ì¿ ë¥´ì” ë¶ë¶€ ì§€ë„ ë³´ì—¬ì¤˜">ì¿ ë¥´ì” ë¶ë¶€ ì§€ë„ ë³´ì—¬ì¤˜</button>
        <button class="quick-btn" data-question="ì¹´ë˜ ì…ì¥ ì¡°ê±´ì´ ë­ì•¼?">ì¹´ë˜ ì…ì¥ ì¡°ê±´ì´ ë­ì•¼?</button>
      </div>
      <button class="scroll-arrow right" id="scrollRight">
        <svg viewBox="0 0 24 24"><path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"/></svg>
      </button>
    </div>

    <div class="d-flex" style="gap:10px">
      <input id="chatInput" class="form-control form-control-lg" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”" />
      <button id="sendBtn" class="btn btn-lg" style="background:var(--accent); color:white; border:none; box-shadow:var(--shadow)">ì „ì†¡</button>
    </div>
    <div id="hint" class="mt-2" style="color:var(--muted); font-size:14px">Tip: "ì¿ ë¥´ì” ë¶ë¶€ ì§€ë„ ë³´ì—¬ì¤˜", "ì›í•œ ìœ ë¬¼ ê°ì¸ì„œ ê°€ê²©" ì²˜ëŸ¼ ì§ˆë¬¸í•´ë³´ì„¸ìš”.</div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const chatWindow = document.getElementById("chatWindow");
  const chatInput  = document.getElementById("chatInput");
  const sendBtn    = document.getElementById("sendBtn");
  const hint       = document.getElementById("hint");
  const quickQuestionsContainer = document.getElementById("quickQuestions");
  const scrollLeftBtn = document.getElementById("scrollLeft");
  const scrollRightBtn = document.getElementById("scrollRight");
  
  let isBusy = false;

  // âœ… ìŠ¤í¬ë¡¤ í™”ì‚´í‘œ í‘œì‹œ/ìˆ¨ê¹€ ì—…ë°ì´íŠ¸
  function updateScrollArrows() {
    const container = quickQuestionsContainer;
    const maxScroll = container.scrollWidth - container.clientWidth;
    
    if (maxScroll <= 0) {
      scrollLeftBtn.classList.add("hidden");
      scrollRightBtn.classList.add("hidden");
    } else {
      scrollLeftBtn.classList.toggle("hidden", container.scrollLeft <= 0);
      scrollRightBtn.classList.toggle("hidden", container.scrollLeft >= maxScroll - 5);
    }
  }

  // âœ… ìŠ¤í¬ë¡¤ ë²„íŠ¼ ì´ë²¤íŠ¸
  scrollLeftBtn.addEventListener("click", () => {
    quickQuestionsContainer.scrollBy({ left: -200, behavior: "smooth" });
  });
  scrollRightBtn.addEventListener("click", () => {
    quickQuestionsContainer.scrollBy({ left: 200, behavior: "smooth" });
  });
  quickQuestionsContainer.addEventListener("scroll", updateScrollArrows);
  window.addEventListener("resize", updateScrollArrows);
  
  // ì´ˆê¸° í™”ì‚´í‘œ ìƒíƒœ
  setTimeout(updateScrollArrows, 100);

  // âœ… ë¹ ë¥¸ ì§ˆë¬¸ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  document.querySelectorAll(".quick-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const question = btn.dataset.question;
      if (question && !isBusy) {
        chatInput.value = question;
        sendQuestion();
      }
    });
  });

  function scrollToEnd(){
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  function addRow(role){
    const row = document.createElement("div");
    row.className = role === "user" ? "row-user" : "row-bot";
    chatWindow.appendChild(row);
    return row;
  }

  function addBubble(role, text=""){
    const row = addRow(role);
    const b = document.createElement("div");
    b.className = `bubble ${role === "user" ? "bubble-user" : "bubble-bot"}`;
    b.textContent = text;
    row.appendChild(b);
    scrollToEnd();
    return b;
  }

  // âœ… íƒ€ì(íƒ€ì´í•‘) íš¨ê³¼
  async function typeOut(el, text, cps=40){
    el.textContent = "";
    for (let i=0; i<text.length; i++){
      el.textContent += text[i];
      if (i % 2 === 0) await new Promise(r=>setTimeout(r, Math.max(5, 1000/cps)));
      scrollToEnd();
    }
  }

  // âœ… ë¡œë”© ìŠ¤í”¼ë„ˆ (ë´‡)
  function addSpinner(){
    const row = addRow("bot");
    const wrap = document.createElement("div");
    wrap.className = "bubble bubble-bot";
    wrap.innerHTML = `ìƒê° ì¤‘<span class="spinner" aria-label="loading"></span>`;
    row.appendChild(wrap);
    scrollToEnd();
    return row;
  }

  // âœ… ì´ë¯¸ì§€(ì§€ë„ ë“±) ë¸”ë¡
  function appendAnswerHTML(html){
    const block = document.createElement("div");
    block.className = "answer-block";

    const card = document.createElement("div");
    card.className = "answer-card animate-pop";
    card.innerHTML = html;

    Array.from(card.querySelectorAll("img")).forEach(img=>{
      if (img.complete) img.classList.add("loaded");
      else img.addEventListener("load", ()=>img.classList.add("loaded"), { once:true });
    });

    block.appendChild(card);
    chatWindow.appendChild(block);
    scrollToEnd();
  }

  // âœ… ì¶œì²˜ ì¹´ë“œ(ì˜µì…˜)
  function appendSources(sources=[]){
    if (!sources?.length) return;
    const box = document.createElement("div");
    box.className = "source-card";
    box.innerHTML = sources.map(s =>
      `ğŸ“„ <a target="_blank" href="${s.url}">${s.title||s.url}</a> <small>(${s.type||"source"})</small>`
    ).join("<br/>");
    chatWindow.appendChild(box);
    scrollToEnd();
  }

  async function sendQuestion(){
    const q = (chatInput.value||"").trim();
    if (!q || isBusy) return;

    isBusy = true;
    chatInput.disabled = true;
    sendBtn.disabled = true;

    addBubble("user", q);
    chatInput.value = "";

    const spinnerRow = addSpinner();

    try {
      const res = await fetch("/api/chat", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ q, question: q })
      });

      let data;

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.detail || `HTTP ${res.status}`);
      } else {
        data = await res.json();
      }

      spinnerRow.remove();

      const botBubble = addBubble("bot", "");
      await typeOut(botBubble, data.answer || "", 25);

      if (data.type === "map") {
        if (data.answer_html) appendAnswerHTML(data.answer_html);
      } else if (data.answer_html) {
        appendAnswerHTML(data.answer_html);
      }

      if (data.sources?.length) appendSources(data.sources);

    } catch (e){
      console.error(e);
      spinnerRow.remove();
      addBubble("bot", "âš ï¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    } finally {
      isBusy = false;
      chatInput.disabled = false;
      sendBtn.disabled = false;
      chatInput.focus();
      scrollToEnd();
    }
  }

  // ì´ˆê¸° í™˜ì˜
  addBubble("bot", "ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”? ğŸ˜Š");

  // ì´ë²¤íŠ¸
  sendBtn.addEventListener("click", sendQuestion);
  chatInput.addEventListener("keydown", e=>{
    if (e.key === "Enter") sendQuestion();
  });
</script>
{% endblock %}