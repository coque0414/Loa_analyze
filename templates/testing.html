{% extends "base.html" %}
{% block title %}ë¡œì•„ ë„ìš°ë¯¸ â€“ RAG ì±—ë´‡{% endblock %}

{% block content %}
<style>
  /* ë ˆì´ì•„ì›ƒ */
  .chat-card{
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 18px;
    box-shadow: var(--shadow);
  }
  #chatWindow{
    height: min(72vh, 820px); /* ì°½ í¬ê²Œ */
    overflow-y: auto;
    padding: 20px;
    background: linear-gradient(180deg, #ffffff 0%, #fbfdfc 100%);
    border-radius: 14px;
  }

  /* ë§í’ì„  ê³µí†µ */
  .bubble{
    display:inline-block;
    max-width: 88%;
    padding: 12px 14px;
    border-radius: 14px;
    line-height: 1.6;
    font-size: 16.5px;      /* ê°€ë…ì„± ìƒìŠ¹ */
    word-break: break-word;
    white-space: pre-wrap;
    box-shadow: 0 2px 10px rgba(0,0,0,.04);
  }
  /* ë´‡(ì™¼ìª½ ì •ë ¬) */
  .row-bot{ text-align:left; margin: 8px 0 }
  .bubble-bot{
    background: var(--bot);
    color: var(--text);
    border: 1px solid var(--border);
  }
  /* ìœ ì €(ì˜¤ë¥¸ìª½ ì •ë ¬) */
  .row-user{ text-align:right; margin: 8px 0 }
  .bubble-user{
    background: linear-gradient(135deg, var(--user-grad-a), var(--user-grad-b));
    color: #0b2530;
    border: none;
    animation: popIn .18s ease-out;
  }
  @keyframes popIn{
    from{ transform: scale(.9); opacity: .0 }
    to  { transform: scale(1);  opacity: 1 }
  }

  /* ì¹´ë“œ/ì´ë¯¸ì§€ ì˜ì—­ */
  .answer-block{
    text-align:left; margin: 10px 0;
  }
  .answer-card{
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px;
    box-shadow: var(--shadow);
  }

  /* ë¡œë”©: íšŒì „ ì›í˜• ìŠ¤í”¼ë„ˆ */
  .spinner {
    width: 22px; height: 22px;
    border: 3px solid #d1e8e4;
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    display:inline-block; vertical-align:middle; margin-left:6px;
  }
  @keyframes spin { to { transform: rotate(360deg) } }

  /* ì†ŒìŠ¤ ì¹´ë“œ (ì˜µì…˜) */
  .source-card {
    background-color: #f4faf8;
    border-left: 4px solid var(--accent);
    padding: .5rem .75rem;
    margin-top: .5rem;
    border-radius: .5rem;
    font-size: 14px;
  }
  .source-card a{ text-decoration:none; color:#0b7266; font-weight:600 }
  .source-card small{ color: var(--muted) }

  @media (max-width: 576px){
    .bubble{ max-width:100%; font-size: 16px }
  }

  /* ì¹´ë“œ/ì´ë¯¸ì§€ íŒ ì• ë‹ˆë©”ì´ì…˜ */
  .animate-pop{ 
    animation: popCard .24s cubic-bezier(.2,.8,.2,1);
    transform-origin: 50% 55%;
  }
  @keyframes popCard{
    0%   { transform: scale(.92); opacity: 0 }
    60%  { transform: scale(1.03); opacity: 1 }
    100% { transform: scale(1) }
  }

  /* ì´ë¯¸ì§€ê°€ ëŠ¦ê²Œ ë¡œë“œë  ë•Œ ë¶€ë“œëŸ½ê²Œ ë‚˜íƒ€ë‚˜ê¸° */
  .answer-card img{ opacity: 0; transition: opacity .2s ease }
  .answer-card img.loaded{ opacity: 1 }

</style>

<div class="container py-4">
  <div class="d-flex align-items-center mb-3" style="gap:10px">
    <img src="https://static.thenounproject.com/png/1245340-200.png" alt="mokoko"
         width="28" height="28" style="opacity:.8"/>
    <h2 class="m-0" style="font-weight:800; letter-spacing:-.3px">ë¡œì•„ ë„ìš°ë¯¸</h2>
    <span class="ms-2 badge rounded-pill" style="background:#e8f7f3; color:#0b7266">ChatBot</span>
  </div>

  <div class="chat-card p-3">
    <div id="chatWindow"></div>

    <div class="mt-3 d-flex" style="gap:10px">
      <input id="chatInput" class="form-control form-control-lg" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”" />
      <button id="sendBtn" class="btn btn-lg" style="background:var(--accent); color:white; border:none; box-shadow:var(--shadow)">ì „ì†¡</button>
    </div>
    <div id="hint" class="mt-2" style="color:var(--muted); font-size:14px">Tip: â€œì¿ ë¥´ì” ë¶ë¶€ ì§€ë„ ë³´ì—¬ì¤˜â€, â€œì›í•œ ìœ ë¬¼ ê°ì¸ì„œ ê°€ê²©â€ ì²˜ëŸ¼ ì§ˆë¬¸í•´ë³´ì„¸ìš”.</div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const chatWindow = document.getElementById("chatWindow");
  const chatInput  = document.getElementById("chatInput");
  const sendBtn    = document.getElementById("sendBtn");
  const hint       = document.getElementById("hint");
  let isBusy = false;   // âœ… ì‘ë‹µ ì¤‘ ì°¨ë‹¨

  function scrollToEnd(){
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  function addRow(role){
    const row = document.createElement("div");
    row.className = role === "user" ? "row-user" : "row-bot";
    chatWindow.appendChild(row);
    return row;
  }

  function addBubble(role, text=""){
    const row = addRow(role);
    const b = document.createElement("div");
    b.className = `bubble ${role === "user" ? "bubble-user" : "bubble-bot"}`;
    b.textContent = text;
    row.appendChild(b);
    scrollToEnd();
    return b;
  }

  // âœ… íƒ€ì(íƒ€ì´í•‘) íš¨ê³¼
  async function typeOut(el, text, cps=40){
    el.textContent = ""; // í•œ ê¸€ìì”© íƒ€ì´í•‘
    for (let i=0; i<text.length; i++){
      el.textContent += text[i];
      if (i % 2 === 0) await new Promise(r=>setTimeout(r, Math.max(5, 1000/cps)));
      scrollToEnd();
    }
  }

  // âœ… ë¡œë”© ìŠ¤í”¼ë„ˆ (ë´‡)
  function addSpinner(){
    const row = addRow("bot");
    const wrap = document.createElement("div");
    wrap.className = "bubble bubble-bot";
    wrap.innerHTML = `ìƒê° ì¤‘<span class="spinner" aria-label="loading"></span>`;
    row.appendChild(wrap);
    scrollToEnd();
    return row; // row ìì²´ë¥¼ ë°˜í™˜(í†µì§¸ë¡œ ì œê±°ìš©)
  }

  // âœ… ì´ë¯¸ì§€(ì§€ë„ ë“±) ë¸”ë¡
  function appendAnswerHTML(html){
    const block = document.createElement("div");
    block.className = "answer-block";

    // ì¹´ë“œì— ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ ë¶€ì—¬
    const card = document.createElement("div");
    card.className = "answer-card animate-pop";
    card.innerHTML = html;

    // ëŠ¦ê²Œ ì˜¤ëŠ” ì´ë¯¸ì§€ë„ ìì—°ìŠ¤ëŸ½ê²Œ ë“±ì¥
    Array.from(card.querySelectorAll("img")).forEach(img=>{
      if (img.complete) img.classList.add("loaded");
      else img.addEventListener("load", ()=>img.classList.add("loaded"), { once:true });
    });

    block.appendChild(card);
    chatWindow.appendChild(block);
    scrollToEnd();
  }

  // âœ… ì¶œì²˜ ì¹´ë“œ(ì˜µì…˜)
  function appendSources(sources=[]){
    if (!sources?.length) return;
    const box = document.createElement("div");
    box.className = "source-card";
    box.innerHTML = sources.map(s =>
      `ğŸ“„ <a target="_blank" href="${s.url}">${s.title||s.url}</a> <small>(${s.type||"source"})</small>`
    ).join("<br/>");
    chatWindow.appendChild(box);
    scrollToEnd();
  }

  async function sendQuestion(){
    const q = (chatInput.value||"").trim();
    if (!q || isBusy) return;

    isBusy = true;
    chatInput.disabled = true;
    sendBtn.disabled = true;

    // ìœ ì € ë§í’ì„  (íŒ ì• ë‹ˆë©”ì´ì…˜)
    addBubble("user", q);
    chatInput.value = "";

    // ë¡œë”© ìŠ¤í”¼ë„ˆ
    const spinnerRow = addSpinner();

    try {
      const res = await fetch("/api/chat", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ q, question: q })
      });

      let data;

      if (!res.ok) {
        // 400 ê°™ì€ ê²½ìš° ë©”ì‹œì§€ êº¼ë‚´ì„œ ì•ˆë‚´
        const err = await res.json().catch(() => ({}));
        throw new Error(err.detail || `HTTP ${res.status}`);
      } else {
        data = await res.json();
      }

      // ìŠ¤í”¼ë„ˆ ì œê±°
      spinnerRow.remove();

      // ë´‡ íƒ€ì´í•‘ ì¶œë ¥ (ëŒ€ë‹µ ì†ë„ ì¡°ì ˆí•˜ëŠ”ë¶€ë¶„)
      const botBubble = addBubble("bot", "");  // ë¹ˆ ë§í’ì„ 
      await typeOut(botBubble, data.answer || "", 25); // cps ì†ë„ ì¡°ì ˆ

      // HTML ì¹´ë“œ(ê·¸ë˜í”„/ëª¨í—˜ì„¬/ì§€ë„ ë“±)ëŠ” ë§í’ì„  ì•„ë˜ì— ë¸”ë¡ìœ¼ë¡œ
      if (data.type === "map") {
        if (data.answer_html) appendAnswerHTML(data.answer_html);
        // map ì „ìš© fallback ì´ë¯¸ì§€ í•„ìš” ì‹œ ì—¬ê¸°ì— ì¶”ê°€ ê°€ëŠ¥
      } else if (data.answer_html) {
        appendAnswerHTML(data.answer_html);
      }

      // (ì„ íƒ) ì¶œì²˜ ì¹´ë“œê°€ ìˆìœ¼ë©´
      if (data.sources?.length) appendSources(data.sources);

    } catch (e){
      console.error(e);
      spinnerRow.remove();
      addBubble("bot", "âš ï¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    } finally {
      isBusy = false;
      chatInput.disabled = false;
      sendBtn.disabled = false;
      chatInput.focus();
      scrollToEnd();
    }
  }

  // ì´ˆê¸° í™˜ì˜
  addBubble("bot", "ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”? ğŸ˜Š");

  // ì´ë²¤íŠ¸
  sendBtn.addEventListener("click", sendQuestion);
  chatInput.addEventListener("keydown", e=>{
    if (e.key === "Enter") sendQuestion();
  });
</script>
{% endblock %}
