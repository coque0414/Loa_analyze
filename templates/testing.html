{% extends "base.html" %}
{% block title %}í…ŒìŠ¤íŠ¸ ì¤‘ â€“ RAG ì±—ë´‡ (ì¶œì²˜ í‘œì‹œ ë²„ì „){% endblock %}

{% block content %}
<style>
  /* âœ… ì±„íŒ… ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
  #chatWindow .badge {
    display: inline-block;
    white-space: pre-wrap;
    word-break: break-word;
    max-width: 80%;
  }

  @media (max-width: 576px) {
    #chatWindow .badge { max-width: 100%; }
  }

  /* âœ… ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
  .loading-dots::after {
    content: "";
    animation: dots 1.2s infinite steps(3, end);
  }

  @keyframes dots {
    0% { content: ""; }
    33% { content: "."; }
    66% { content: ".."; }
    100% { content: "..."; }
  }

  /* âœ… ì¶œì²˜ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
  .source-card {
    background-color: #f8f9fa;
    border-left: 4px solid #0d6efd;
    padding: .5rem .75rem;
    margin-top: .5rem;
    border-radius: .25rem;
    font-size: 0.9rem;
  }
  .source-card a {
    text-decoration: none;
    color: #0d6efd;
    font-weight: 500;
  }
  .source-card a:hover {
    text-decoration: underline;
  }
  .source-card small {
    color: #6c757d;
  }
</style>

<div class="container py-5">
  <h1 class="mb-4">í…ŒìŠ¤íŠ¸ ì¤‘ (RAG ì±—ë´‡, 25ë…„ 9ì›” ê¸°ì¤€)</h1>
  <div class="card mb-4">
    <div class="card-body">
      <div id="chatWindow"
           style="height:400px;
                  overflow-y:auto;
                  padding:1rem;
                  border:1px solid #dee2e6;
                  border-radius:.25rem;
                  background:#fff;">
      </div>
      <div class="input-group mt-3">
        <input type="text" id="chatInput"
               class="form-control"
               placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”â€¦" />
        <button id="sendBtn" class="btn btn-primary">ì „ì†¡</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const chatWindow = document.getElementById("chatWindow");
  const chatInput  = document.getElementById("chatInput");
  const sendBtn    = document.getElementById("sendBtn");

  // âœ… ì•ˆì „í•œ í…ìŠ¤íŠ¸ ì²˜ë¦¬
  function appendMessage(role, text, isLoading=false) {
    const wrapper = document.createElement("div");
    wrapper.className = role === "user" ? "text-end mb-2" : "text-start mb-2";

    const span = document.createElement("span");
    span.className = `badge ${role==="user"?"bg-primary":"bg-secondary"} p-2`;
    if (isLoading) span.classList.add("loading-dots");
    span.textContent = text;

    wrapper.appendChild(span);
    chatWindow.appendChild(wrapper);

    span.scrollIntoView({ behavior: "smooth", block: "end" });
    return wrapper;
  }

  // âœ… ì¶œì²˜ ì¹´ë“œ ì¶”ê°€ í•¨ìˆ˜
  function appendSources(parent, sources=[]) {
    if (!sources.length) return;
    const box = document.createElement("div");
    box.className = "mt-2";

    sources.forEach(src => {
      const div = document.createElement("div");
      div.className = "source-card";
      const icon = src.type === "youtube" ? "â–¶ï¸"
                : src.type === "community" ? "ğŸ’¬"
                : "ğŸ“„";
      div.innerHTML = `${icon} <a href="${src.url}" target="_blank">${src.title}</a><br><small>${src.type}</small>`;
      box.appendChild(div);
    });
    parent.appendChild(box);
  }

  async function sendQuestion() {
    const question = chatInput.value.trim();
    if (!question) return;

    appendMessage("user", question);
    chatInput.value = "";
    chatInput.focus();
    sendBtn.disabled = true;

    const loadingMsg = appendMessage("bot", "ë‹µë³€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘", true);

    try {
      const res = await fetch("/api/chat", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ question })
      });

      if (!res.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜");

      const { answer, sources } = await res.json();

      chatWindow.removeChild(chatWindow.lastElementChild);

      // âœ… ë‹µë³€ ë©”ì‹œì§€ì™€ ì¶œì²˜ í•¨ê»˜ ì¶”ê°€
      const msg = appendMessage("bot", answer);
      appendSources(msg, sources);

    } catch (err) {
      console.error(err);
      chatWindow.removeChild(chatWindow.lastElementChild);
      appendMessage("bot", "âš ï¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    } finally {
      sendBtn.disabled = false;
    }
  }

  appendMessage("bot", "ì•ˆë…•í•˜ì„¸ìš”! ê¶ê¸ˆí•œ ê²ƒì´ ìˆìœ¼ë©´ ë¬¼ì–´ë³´ì„¸ìš” ğŸ˜Š");

  sendBtn.addEventListener("click", sendQuestion);
  chatInput.addEventListener("keydown", e => {
    if (e.key === "Enter") sendQuestion();
  });
</script>
{% endblock %}
