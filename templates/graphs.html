{% extends "base.html" %} {% block title %}ë¹„ë°€ì˜ ê·¸ë˜í”„ ê³µê°„{% endblock %} {%
block content %}
<style>
  body {
    background: #dfeaf9;
  }
  .graph-section {
    max-width: 800px;
    margin: auto;
  }
  .graph-section .card-body {
    background: #fff;
  }
  /* â–¶ï¸ ì•„ì´í…œ ëª©ë¡ì´ ë„˜ì¹  ë•Œ ìˆ˜í‰ ìŠ¤í¬ë¡¤ */
  .part-select {
    flex-wrap: nowrap;
    overflow-x: auto;
    padding-bottom: 0.5rem;
  }
  .part-select::-webkit-scrollbar {
    height: 16px;
  }
  .part-select::-webkit-scrollbar-thumb {
    background: #ced4da;
    border-radius: 4px;
  }
  .part-select::-webkit-scrollbar-track {
    background: transparent;
  }
  .part-item input:checked + .card {
    outline: 3px solid #0d6efd;
    transform: translateY(-3px);
    transition: 0.2s;
  }
  .part-item .card {
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.05);
    cursor: pointer;
  }
  /* ëŒ€í‘œ ê²Œì‹œê¸€ìš© ì¹´ë“œ ê·¸ë¦¬ë“œ + í˜ì´ë“œì¸ ì• ë‹ˆë©”ì´ì…˜ */
  .rep-wrap {
    display: grid;
    gap: 0.75rem;
  } /* ì¹´ë“œ ê°„ê²© */
  @media (min-width: 768px) {
    .rep-wrap {
      grid-template-columns: 1fr 1fr;
    }
  }


  /* ì±„íŒ…ì°½ ë°°ì§€ í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ í—ˆìš© */
  #chatWindow .badge {
    display: inline-block;  /* badgeë„ ì¤„ë°”ê¿ˆ í—ˆìš© */
    white-space: pre-wrap;
    word-break: break-word;
    max-width: 80%;
  }

  .rep-card {
    opacity: 0;
    transform: translateY(15px);
    transition: opacity 0.4s ease, transform 0.4s ease;
  }
  .rep-card.show {
    opacity: 1;
    transform: none;
  }
</style>

<div class="graph-section">
  <!-- ì•„ì´í…œ ì„ íƒ -->
  <div class="card mb-3">
    <div class="card-body">
      <h6 class="fw-bold mb-3">Choose a part</h6>
      <div class="d-flex gap-4 part-select">
        {% for it in items %}
        <label class="part-item text-center">
          <input
            type="radio"
            name="part"
            value="{{it.code}}"
            hidden
            {%
            if
            loop.first
            %}checked{%
            endif
            %}
          />
          <div class="card"><img src="{{it.img}}" class="img-fluid" /></div>
          <small class="d-block mt-2">{{it.name}}</small>
        </label>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- plotly ê·¸ë˜í”„ -->
  <div class="card">
    <div class="card-body">
      <div id="priceChart" style="width: 100%; height: 250px"></div>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <div id="predChart" style="width: 100%; height: 300px"></div>
    </div>

  </div>

  <!-- ğŸ“… ìº˜ë¦°ë”(ìƒì‹œ í‘œì‹œ) -->
  <!-- flatpickr dark theme (ìœˆë„ìš° ë‹¬ë ¥ ëŠë‚Œ) -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css"
  />
  <div class="card mt-3">
    <div class="card-body">
      <div class="row g-0">
      <!-- LEFT: ìº˜ë¦°ë” -->
      <div class="col-md-5 d-flex">
        <!-- í° ë°°ê²½ ì¹´ë“œ -->
        <div class="w-100">
          <div id="calendar"></div>
        </div>
      </div>

      <!-- RIGHT: ìš”ì•½ -->
      <div class="col-md-7 d-flex align-items-center">
        <div id="summaryBox"
              class="w-100 fs-5 text-center py-4">
          í•´ë‹¹ ë‚ ì§œë¥¼ ì„ íƒí•˜ì—¬<br>
          <strong>ì»¤ë®¤ë‹ˆí‹° ë¶„ìœ„ê¸° ìš”ì•½ë¬¸</strong>ì„<br>
          ë³´ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
      </div>

      </div> <!-- /.row -->
    </div>   <!-- /.card-body -->
  </div>     <!-- /.card -->
    <!-- â–¶ ìº˜ë¦°ë”+ìš”ì•½ ì¹´ë“œ ë -->

  <!-- â”€â”€ ëŒ€í‘œ ê²Œì‹œê¸€ ë²„íŠ¼ ë¦¬ìŠ¤íŠ¸ â”€â”€ -->
  <div id="repList" class="d-grid gap-2 mt-3"></div>
  <!-- â”€â”€ ë¦¬ìŠ¤íŠ¸ ë â”€â”€ -->

<div></div>

  <!-- â”€â”€ ì±—ë´‡ UI ì‹œì‘ â”€â”€ -->
  <div class="card mt-4 mb-3">
    <div class="card-body">
      <h5 class="card-title text-center">ì±—ë´‡</h5>
      <div id="chatWindow"
            style="height:300px;
                  overflow-y:auto;
                  padding:1rem;
                  border:1px solid #dee2e6;
                  border-radius:.25rem;
                  background:#fff;">
      </div>
      <div class="input-group mt-3">
        <input type="text" id="chatInput" class="form-control"
                placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”â€¦" />
        <button id="sendBtn" class="btn btn-primary">ì „ì†¡</button>
      </div>
    </div>
  </div>
  <!-- â”€â”€ ì±—ë´‡ UI ë â”€â”€ -->

  <!-- plotly.js CDN -->
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <!-- flatpickr (calendar) -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
  <script>
    const DEFAULT_CODE = 65200505;
    let currentKeyword = 'ìœ ê°';

    // divId: ê·¸ë˜í”„ë¥¼ ê·¸ë¦´ <div> id, dataTraces: ì›í•˜ëŠ” trace ë°°ì—´, layout: ë ˆì´ì•„ì›ƒ
    async function animatePlot(divId, dataTraces, layout) {
      // 1. yì¶• ë²”ìœ„ ê³„ì‚°
      let allY = [];
      dataTraces.forEach(trace => {
        if (trace.y) allY = allY.concat(trace.y);
      });
      const minY = Math.min(...allY);
      const maxY = Math.max(...allY);

      // 2. layout ë³µì‚¬ ë° yaxis ë²”ìœ„ ê³ ì •
      const fixedLayout = {
        ...layout,
        yaxis: {
          ...layout.yaxis,
          range: [Math.min(0, minY), maxY * 1.05]  // ì•½ê°„ ìœ„ë¡œ ì—¬ìœ  ì¤Œ
        }
      };

      // 3. ì´ˆê¸° y=0 ìœ¼ë¡œ ì„¤ì •
      const initTraces = dataTraces.map(trace => ({
        ...trace,
        y: trace.y.map(_ => 0)
      }));

      // 4. ì´ˆê¸° ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
      await Plotly.newPlot(divId, initTraces, fixedLayout, { responsive: true });

      // 5. ì• ë‹ˆë©”ì´ì…˜ ì ìš©
      Plotly.animate(divId, {
        data: dataTraces
      }, {
        transition: {
          duration: 800,
          easing: 'bounce'
        },
        frame: {
          duration: 800,
          redraw: true
        }
      });
    }



    async function fetchData(code){
      const res = await fetch(`/api/market?code=${code}`);
      if(!res.ok) throw new Error('No data');
      return res.json();
    }

    function drawPlot(data){
      const dates  = data.map(d=>d.date);
      const prices = data.map(d=>d.avg_price);
      const trades = data.map(d=>d.trade_count);

      const bar = { x:dates, y:trades, type:'bar', name:'íŒë§¤ëŸ‰', marker:{color:'#0d6efd'}, yaxis:'y' };
      const line= { x:dates, y:prices, type:'scatter', mode:'lines+markers', name:'í‰ê· ê°€', marker:{size:6}, line:{width:2,color:'#28a745'}, yaxis:'y2' };
      const layout={
        title:'ë‚ ì§œë³„ í‰ê· ê°€ Â· íŒë§¤ëŸ‰',
        yaxis:{title:'íŒë§¤ëŸ‰',rangemode:'tozero'},
        yaxis2:{title:'í‰ê· ê°€',overlaying:'y',side:'right'},
        legend:{orientation:'h',x:0,y:1.15},
        margin:{t:60,r:60,b:60,l:60}
      };
      Plotly.react('priceChart',[bar,line],layout);
    }

    async function fetchPredictions(code) {
      const res = await fetch(`/api/predictions?item_code=${code}`);
      if(!res.ok) return [];
      return res.json();
    }

    function drawPredPlot(actual, preds) {
      // 1) ì§€ë‚œ 7ì¼ì¹˜ë§Œ ìë¥´ê¸°
      const lastWeek = actual.slice(-7);
      const datesAct = lastWeek.map(d => d.date);
      const pricesAct= lastWeek.map(d => d.avg_price);
      const trades   = lastWeek.map(d => d.trade_count);

      // 2) ì˜ˆì¸¡ 7ì¼
      const datesPred  = preds.map(p => p.date);
      const pricesPred = preds.map(p => p.price_pred);

      // 3) ì°¸ê³ ìš© íŒë§¤ëŸ‰ Bar (íˆ¬ëª…ë„ ë‚®ì¶¤)
      const traceBar = {
        x: datesAct,
        y: trades,
        type: 'bar',
        name: 'íŒë§¤ëŸ‰(ì°¸ê³ )',
        marker: { color: '#0d6efd' },
        opacity: 0.3,
        yaxis: 'y'     // ì™¼ìª½ ì¶•
      };

      // 4) ì‹¤ì œ í‰ê· ê°€ ì„ 
      const traceAct = {
        x: datesAct,
        y: pricesAct,
        type: 'scatter',
        mode: 'lines+markers',
        name: 'í‰ê· ê°€(ì‹¤ì œ)',
        line:  { color: '#28a745', width: 2 },
        marker:{ size: 6 },
        yaxis: 'y2'    // ì˜¤ë¥¸ìª½ ì¶•
      };

      // 5) ì˜ˆì¸¡ í‰ê· ê°€ ì ì„ 
      const tracePred = {
        x: datesPred,
        y: pricesPred,
        type: 'scatter',
        mode: 'lines+markers',
        name: 'í‰ê· ê°€(ì˜ˆì¸¡)',
        line: {
          color: '#ff5733',
          width: 2,
          dash: 'dashdot'
        },
        marker:{ size: 6 },
        yaxis: 'y2'
      };

      // 6) ë ˆì´ì•„ì›ƒ: ì™¼ìª½ì€ íŒë§¤ëŸ‰, ì˜¤ë¥¸ìª½ì€ í‰ê· ê°€
      const layout = {
        title: 'ì§€ë‚œ ì£¼ ì‹¤ ê·¸ë˜í”„, ë‹¤ìŒ ì£¼ ì˜ˆì¸¡ í‰ê· ',
        yaxis: {
          title: 'íŒë§¤ëŸ‰',
          rangemode: 'tozero',
          titlefont: { color: '#0d6efd' },
          tickfont:  { color: '#0d6efd' }
        },
        yaxis2: {
          title: 'í‰ê· ê°€',
          overlaying: 'y',
          side: 'right',
          titlefont: { color: '#28a745' },
          tickfont:  { color: '#28a745' }
        },
        legend: { orientation: 'h', x: 0, y: 1.15 },
        margin: { t:50, r:60, b:50, l:60 }
      };

      // 7) ë Œë”ë§: bar + ì‹¤ì œì„  + ì˜ˆì¸¡ì„ 
      Plotly.react('predChart',
        [ traceBar, traceAct, tracePred ],
        layout
      );
    }



    async function loadPredChart(code) {
      try {
        const [actual, preds] = await Promise.all([
          fetchData(code),         // ì „ì²´ actual
          fetchPredictions(code)   // ì˜ˆì¸¡
        ]);
        drawPredPlot(actual, preds);
      } catch(e) {
        console.error(e);
        Plotly.purge('predChart');
      }
    }




    async function loadChart(code){
      try{ drawPlot(await fetchData(code)); }
      catch(e){ console.error(e); Plotly.purge('priceChart'); }
    }

    /* ìœ í‹¸: ë‚ ì§œ ê°ì²´ â†’ 'YYYY-MM-DD' */
    function fmtDate(d){
      return d.toISOString().slice(0,10);
    }

    /* ìš”ì•½ ë¡œë” */
    async function loadSummary(dateStr){
      console.log("â–¶ loadSummary í˜¸ì¶œ:", dateStr);
      <!-- const guide = document.getElementById('guideMsg'); -->
      const box   = document.getElementById('summaryBox');
      const wrap  = document.getElementById('repList');   // â† repList â†’ wrap

      <!-- guide.style.display = 'none'; -->
      box.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';
      wrap.innerHTML  = '';

      try{
        const res = await fetch(
          `/api/daily_summary?date=${dateStr}` +
          `&keyword=${encodeURIComponent(currentKeyword)}`
        );
        if(res.status === 204){
          box.textContent = 'í•´ë‹¹í•˜ëŠ” ë‚ ì§œì—ëŠ” ìš”ì•½ì´ ì—†ìŠµë‹ˆë‹¤.';
          return;
        }
        if(!res.ok) throw new Error();

        const {summary, representatives} = await res.json();

        /* â­ ì¤„ë„˜ê¹€ í¬í•¨, ê°•ì¡° í‘œì‹œ */
        box.innerHTML =
          `í•´ë‹¹ ë‚ ì§œì˜ ì»¤ë®¤ë‹ˆí‹° ìœ ì €ë“¤ì˜ ë°˜ì‘ ë˜ëŠ” ë¶„ìœ„ê¸°ëŠ”<br>
           <strong>" ${summary} "</strong><br>
           ë¼ê³  ë‚˜íƒ€ë‚´ì–´ì§‘ë‹ˆë‹¤.`;

        /* â­ ì¹´ë“œ ë§ˆí¬ì—… */
        wrap.innerHTML = representatives.map((r,i)=>`
          <div class="card rep-card">
            <div class="card-body py-3">
              <a href="${r.url}" target="_blank" class="stretched-link text-decoration-none">
                ${r.title}
              </a>
            </div>
          </div>
        `).join('');

        /* â­ ìˆœì°¨ì  ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ */
        wrap.querySelectorAll('.rep-card').forEach((el,idx)=>
          setTimeout(()=>el.classList.add('show'), idx*120)
        );

      }catch(e){
        box.textContent = 'âš ï¸ ìš”ì•½ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
      }
    }


    document.querySelectorAll('input[name="part"]').forEach(el=>{
      el.addEventListener('change', ()=>{
        loadChart(el.value);      // ê¸°ì¡´ ê·¸ë˜í”„
        loadPredChart(el.value);  // â† ì˜ˆì¸¡ ê·¸ë˜í”„ë„ í•¨ê»˜ ê°±ì‹ 
      });
    });

    window.addEventListener('DOMContentLoaded',()=>{
      loadChart(DEFAULT_CODE);
      loadPredChart(DEFAULT_CODE);
      /* flatpickr ì¸ë¼ì¸ ë‹¬ë ¥ */
      flatpickr('#calendar', {
        inline:true,
        locale:'ko',
        defaultDate:new Date(),
        prevArrow:'â—€',
        nextArrow:'â–¶',

          // ìˆ«ìÂ·í™”ì‚´í‘œë§Œ ê³ ì •
        monthSelectorType:'static',
        onChange:(_, dateStr)=>loadSummary(dateStr),
        showMonths:1,
      });


      // 3) **ì±—ë´‡ ì²« ì¸ì‚¬ë§** ì¶”ê°€**
      appendMessage("bot", "ì•ˆë…•í•˜ì„¸ìš”! ê¶ê¸ˆí•œ ê²ƒì´ ìˆìœ¼ë©´ ë¬¼ì–´ë³´ì„¸ìš”!");

    });

    // â”€â”€ ì±—ë´‡ ê¸°ëŠ¥ ìŠ¤í¬ë¦½íŠ¸ (testing.html ë³µì‚¬) â”€â”€
    const chatWindow = document.getElementById("chatWindow");
    const chatInput  = document.getElementById("chatInput");
    const sendBtn    = document.getElementById("sendBtn");

    function appendMessage(role, text) {
      const wrapper = document.createElement("div");
      wrapper.className = role === "user" ? "text-end mb-2" : "text-start mb-2";
      wrapper.innerHTML = `<span class="badge ${
        role === "user" ? "bg-primary" : "bg-secondary"
      } p-2">${text}</span>`;
      chatWindow.appendChild(wrapper);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    async function sendQuestion() {
      const question = chatInput.value.trim();
      if (!question) return;
      appendMessage("user", question);
      chatInput.value = "";
      try {
        const res = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question })
        });
        if (!res.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜");
        const { answer } = await res.json();
        appendMessage("bot", answer);
      } catch (err) {
        console.error(err);
        appendMessage("bot", "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    }

    sendBtn.addEventListener("click", sendQuestion);
    chatInput.addEventListener("keydown", e => {
      if (e.key === "Enter") sendQuestion();
    });

  </script>
  {% endblock %}
</div>
